cscope 15 $HOME/os161/kern/thread               0000025263
	@clock.c

30 
	~<ty³s.h
>

31 
	~<lib.h
>

32 
	~<ıu.h
>

33 
	~<wchª.h
>

34 
	~<şock.h
>

35 
	~<th»ad.h
>

36 
	~<cu¼’t.h
>

53 
	#SCHEDULE_HARDCLOCKS
 4

	)

54 
	#MIGRATE_HARDCLOCKS
 16

	)

59 
wchª
 *
	glbŞt
;

65 
	$h¬dşock_boÙ¡¿p
()

67 
lbŞt
 = 
	`wchª_ü—‹
("lbolt");

68 ià(
lbŞt
 =ğ
NULL
) {

69 
	`·nic
("Couldn't create†bolt\n");

71 
	}
}

78 
	$tim”şock
()

81 
	`wchª_wak—Î
(
lbŞt
);

82 
	}
}

89 
	$h¬dşock
()

95 
curıu
->
c_h¬dşocks
++;

96 ià((
curıu
->
c_h¬dşocks
 % 
SCHEDULE_HARDCLOCKS
) == 0) {

97 
	`scheduË
();

99 ià((
curıu
->
c_h¬dşocks
 % 
MIGRATE_HARDCLOCKS
) == 0) {

100 
	`th»ad_cÚsid”_mig¿tiÚ
();

102 
	`th»ad_y›ld
();

103 
	}
}

109 
	$şock¦“p
(
num_£cs
)

111 
num_£cs
 > 0) {

112 
	`wchª_lock
(
lbŞt
);

113 
	`wchª_¦“p
(
lbŞt
);

114 
num_£cs
--;

116 
	}
}

	@spinlock.c

31 
	#SPINLOCK_INLINE


	)

33 
	~<ty³s.h
>

34 
	~<lib.h
>

35 
	~<ıu.h
>

36 
	~<¥l.h
>

37 
	~<¥šlock.h
>

38 
	~<cu¼’t.h
>

49 
	$¥šlock_š™
(
¥šlock
 *
lk
)

51 
	`¥šlock_d©a_£t
(&
lk
->
lk_lock
, 0);

52 
lk
->
lk_hŞd”
 = 
NULL
;

53 
	}
}

59 
	$¥šlock_ş—nup
(
¥šlock
 *
lk
)

61 
	`KASSERT
(
lk
->
lk_hŞd”
 =ğ
NULL
);

62 
	`KASSERT
(
	`¥šlock_d©a_g‘
(&
lk
->
lk_lock
) == 0);

63 
	}
}

73 
	$¥šlock_acquœe
(
¥šlock
 *
lk
)

75 
ıu
 *
myıu
;

77 
	`¥Ìai£
(
IPL_NONE
, 
IPL_HIGH
);

80 ià(
	`CURCPU_EXISTS
()) {

81 
myıu
 = 
curıu
->
c_£lf
;

82 ià(
lk
->
lk_hŞd”
 =ğ
myıu
) {

83 
	`·nic
("D—dlock oÀ¥šlock %p\n", 
lk
);

87 
myıu
 = 
NULL
;

101 ià(
	`¥šlock_d©a_g‘
(&
lk
->
lk_lock
) != 0) {

104 ià(
	`¥šlock_d©a_‹¡ªd£t
(&
lk
->
lk_lock
) != 0) {

110 
lk
->
lk_hŞd”
 = 
myıu
;

111 
	}
}

117 
	$¥šlock_»Ëa£
(
¥šlock
 *
lk
)

120 ià(
	`CURCPU_EXISTS
()) {

121 
	`KASSERT
(
lk
->
lk_hŞd”
 =ğ
curıu
->
c_£lf
);

124 
lk
->
lk_hŞd”
 = 
NULL
;

125 
	`¥šlock_d©a_£t
(&
lk
->
lk_lock
, 0);

126 
	`¥Îow”
(
IPL_HIGH
, 
IPL_NONE
);

127 
	}
}

132 
boŞ


133 
	$¥šlock_do_i_hŞd
(
¥šlock
 *
lk
)

135 ià(!
	`CURCPU_EXISTS
()) {

136  
Œue
;

140  (
lk
->
lk_hŞd”
 =ğ
curıu
->
c_£lf
);

141 
	}
}

	@spl.c

31 
	#SPL_INLINE


	)

33 
	~<ty³s.h
>

34 
	~<lib.h
>

35 
	~<ıu.h
>

36 
	~<¥l.h
>

37 
	~<th»ad.h
>

38 
	~<cu¼’t.h
>

87 
	$¥Ìai£
(
Şd¥l
, 
Ãw¥l
)

89 
th»ad
 *
cur
 = 
cu¹h»ad
;

92 
	`KASSERT
(
Şd¥l
 =ğ
IPL_NONE
);

93 
	`KASSERT
(
Ãw¥l
 =ğ
IPL_HIGH
);

95 ià(!
	`CURCPU_EXISTS
()) {

100 ià(
cur
->
t_lhigh_couÁ
 == 0) {

101 
	`ıu_œqoff
();

103 
cur
->
t_lhigh_couÁ
++;

104 
	}
}

107 
	$¥Îow”
(
Şd¥l
, 
Ãw¥l
)

109 
th»ad
 *
cur
 = 
cu¹h»ad
;

112 
	`KASSERT
(
Şd¥l
 =ğ
IPL_HIGH
);

113 
	`KASSERT
(
Ãw¥l
 =ğ
IPL_NONE
);

115 ià(!
	`CURCPU_EXISTS
()) {

120 
cur
->
t_lhigh_couÁ
--;

121 ià(
cur
->
t_lhigh_couÁ
 == 0) {

122 
	`ıu_œqÚ
();

124 
	}
}

132 
	$¥lx
(
¥l
)

134 
th»ad
 *
cur
 = 
cu¹h»ad
;

135 
»t
;

137 ià(
cur
->
t_cur¥l
 < 
¥l
) {

139 
	`¥Ìai£
(
cur
->
t_cur¥l
, 
¥l
);

140 
»t
 = 
cur
->
t_cur¥l
;

141 
cur
->
t_cur¥l
 = 
¥l
;

143 ià(
cur
->
t_cur¥l
 > 
¥l
) {

145 
»t
 = 
cur
->
t_cur¥l
;

146 
cur
->
t_cur¥l
 = 
¥l
;

147 
	`¥Îow”
(
»t
, 
¥l
);

151 
»t
 = 
¥l
;

154  
»t
;

155 
	}
}

	@synch.c

35 
	~<ty³s.h
>

36 
	~<lib.h
>

37 
	~<¥šlock.h
>

38 
	~<wchª.h
>

39 
	~<th»ad.h
>

40 
	~<cu¼’t.h
>

41 
	~<synch.h
>

47 
£m­hÜe
 *

48 
	$£m_ü—‹
(cÚ¡ *
Çme
, 
š™Ÿl_couÁ
)

50 
£m­hÜe
 *
£m
;

52 
	`KASSERT
(
š™Ÿl_couÁ
 >= 0);

54 
£m
 = 
	`km®loc
((
£m­hÜe
));

55 ià(
£m
 =ğ
NULL
) {

56  
NULL
;

59 
£m
->
£m_Çme
 = 
	`k¡rdup
(
Çme
);

60 ià(
£m
->
£m_Çme
 =ğ
NULL
) {

61 
	`kä“
(
£m
);

62  
NULL
;

65 
£m
->
£m_wchª
 = 
	`wchª_ü—‹
(£m->
£m_Çme
);

66 ià(
£m
->
£m_wchª
 =ğ
NULL
) {

67 
	`kä“
(
£m
->
£m_Çme
);

68 
	`kä“
(
£m
);

69  
NULL
;

72 
	`¥šlock_š™
(&
£m
->
£m_lock
);

73 
£m
->
£m_couÁ
 = 
š™Ÿl_couÁ
;

75  
£m
;

76 
	}
}

79 
	$£m_de¡roy
(
£m­hÜe
 *
£m
)

81 
	`KASSERT
(
£m
 !ğ
NULL
);

84 
	`¥šlock_ş—nup
(&
£m
->
£m_lock
);

85 
	`wchª_de¡roy
(
£m
->
£m_wchª
);

86 
	`kä“
(
£m
->
£m_Çme
);

87 
	`kä“
(
£m
);

88 
	}
}

91 
	$P
(
£m­hÜe
 *
£m
)

93 
	`KASSERT
(
£m
 !ğ
NULL
);

101 
	`KASSERT
(
cu¹h»ad
->
t_š_š‹¼u±
 =ğ
çl£
);

103 
	`¥šlock_acquœe
(&
£m
->
£m_lock
);

104 
£m
->
£m_couÁ
 == 0) {

121 
	`wchª_lock
(
£m
->
£m_wchª
);

122 
	`¥šlock_»Ëa£
(&
£m
->
£m_lock
);

123 
	`wchª_¦“p
(
£m
->
£m_wchª
);

125 
	`¥šlock_acquœe
(&
£m
->
£m_lock
);

127 
	`KASSERT
(
£m
->
£m_couÁ
 > 0);

128 
£m
->
£m_couÁ
--;

129 
	`¥šlock_»Ëa£
(&
£m
->
£m_lock
);

130 
	}
}

133 
	$V
(
£m­hÜe
 *
£m
)

135 
	`KASSERT
(
£m
 !ğ
NULL
);

137 
	`¥šlock_acquœe
(&
£m
->
£m_lock
);

139 
£m
->
£m_couÁ
++;

140 
	`KASSERT
(
£m
->
£m_couÁ
 > 0);

141 
	`wchª_wakeÚe
(
£m
->
£m_wchª
);

143 
	`¥šlock_»Ëa£
(&
£m
->
£m_lock
);

144 
	}
}

150 
lock
 *

151 
	$lock_ü—‹
(cÚ¡ *
Çme
)

153 
lock
 *lock;

155 
lock
 = 
	`km®loc
((lock));

156 ià(
lock
 =ğ
NULL
) {

157  
NULL
;

160 
lock
->
lk_Çme
 = 
	`k¡rdup
(
Çme
);

161 ià(
lock
->
lk_Çme
 =ğ
NULL
) {

162 
	`kä“
(
lock
);

163  
NULL
;

168  
lock
;

169 
	}
}

172 
	$lock_de¡roy
(
lock
 *lock)

174 
	`KASSERT
(
lock
 !ğ
NULL
);

178 
	`kä“
(
lock
->
lk_Çme
);

179 
	`kä“
(
lock
);

180 
	}
}

183 
	$lock_acquœe
(
lock
 *lock)

187 ()
lock
;

188 
	}
}

191 
	$lock_»Ëa£
(
lock
 *lock)

195 ()
lock
;

196 
	}
}

198 
boŞ


199 
	$lock_do_i_hŞd
(
lock
 *lock)

203 ()
lock
;

205  
Œue
;

206 
	}
}

213 
cv
 *

214 
	$cv_ü—‹
(cÚ¡ *
Çme
)

216 
cv
 *cv;

218 
cv
 = 
	`km®loc
((cv));

219 ià(
cv
 =ğ
NULL
) {

220  
NULL
;

223 
cv
->
cv_Çme
 = 
	`k¡rdup
(
Çme
);

224 ià(
cv
->
cv_Çme
==
NULL
) {

225 
	`kä“
(
cv
);

226  
NULL
;

231  
cv
;

232 
	}
}

235 
	$cv_de¡roy
(
cv
 *cv)

237 
	`KASSERT
(
cv
 !ğ
NULL
);

241 
	`kä“
(
cv
->
cv_Çme
);

242 
	`kä“
(
cv
);

243 
	}
}

246 
	$cv_wa™
(
cv
 *cv, 
lock
 *lock)

249 ()
cv
;

250 ()
lock
;

251 
	}
}

254 
	$cv_sigÇl
(
cv
 *cv, 
lock
 *lock)

257 ()
cv
;

258 ()
lock
;

259 
	}
}

262 
	$cv_brßdÿ¡
(
cv
 *cv, 
lock
 *lock)

265 ()
cv
;

266 ()
lock
;

267 
	}
}

	@thread.c

34 
	#THREADINLINE


	)

36 
	~<ty³s.h
>

37 
	~<k”n/”ºo.h
>

38 
	~<lib.h
>

39 
	~<¬¿y.h
>

40 
	~<ıu.h
>

41 
	~<¥l.h
>

42 
	~<¥šlock.h
>

43 
	~<wchª.h
>

44 
	~<th»ad.h
>

45 
	~<th»adli¡.h
>

46 
	~<th»ad´iv©e.h
>

47 
	~<´oc.h
>

48 
	~<cu¼’t.h
>

49 
	~<synch.h
>

50 
	~<addr¥aû.h
>

51 
	~<mašbus.h
>

52 
	~<vnode.h
>

54 
	~"İt-synch´obs.h
"

58 
	#THREAD_STACK_MAGIC
 0xb¯df00d

	)

61 
	swchª
 {

62 cÚ¡ *
	mwc_Çme
;

63 
th»adli¡
 
	mwc_th»ads
;

64 
¥šlock
 
	mwc_lock
;

68 
DECLARRAY
(
ıu
);

69 
DEFARRAY
(
ıu
, );

70 
ıu¬¿y
 
	g®lıus
;

73 
£m­hÜe
 *
	gıu_¡¬tup_£m
;

84 
	$th»ad_check¡ack_š™
(
th»ad
 *thread)

86 ((
ušt32_t
 *)
th»ad
->
t_¡ack
)[0] = 
THREAD_STACK_MAGIC
;

87 ((
ušt32_t
 *)
th»ad
->
t_¡ack
)[1] = 
THREAD_STACK_MAGIC
;

88 ((
ušt32_t
 *)
th»ad
->
t_¡ack
)[2] = 
THREAD_STACK_MAGIC
;

89 ((
ušt32_t
 *)
th»ad
->
t_¡ack
)[3] = 
THREAD_STACK_MAGIC
;

90 
	}
}

104 
	$th»ad_check¡ack
(
th»ad
 *thread)

106 ià(
th»ad
->
t_¡ack
 !ğ
NULL
) {

107 
	`KASSERT
(((
ušt32_t
*)
th»ad
->
t_¡ack
)[0] =ğ
THREAD_STACK_MAGIC
);

108 
	`KASSERT
(((
ušt32_t
*)
th»ad
->
t_¡ack
)[1] =ğ
THREAD_STACK_MAGIC
);

109 
	`KASSERT
(((
ušt32_t
*)
th»ad
->
t_¡ack
)[2] =ğ
THREAD_STACK_MAGIC
);

110 
	`KASSERT
(((
ušt32_t
*)
th»ad
->
t_¡ack
)[3] =ğ
THREAD_STACK_MAGIC
);

112 
	}
}

119 
th»ad
 *

120 
	$th»ad_ü—‹
(cÚ¡ *
Çme
)

122 
th»ad
 *thread;

124 
	`DEBUGASSERT
(
Çme
 !ğ
NULL
);

126 
th»ad
 = 
	`km®loc
((*thread));

127 ià(
th»ad
 =ğ
NULL
) {

128  
NULL
;

131 
th»ad
->
t_Çme
 = 
	`k¡rdup
(
Çme
);

132 ià(
th»ad
->
t_Çme
 =ğ
NULL
) {

133 
	`kä“
(
th»ad
);

134  
NULL
;

136 
th»ad
->
t_wchª_Çme
 = "NEW";

137 
th»ad
->
t_¡©e
 = 
S_READY
;

140 
	`th»ad_machd•_š™
(&
th»ad
->
t_machd•
);

141 
	`th»adli¡node_š™
(&
th»ad
->
t_li¡node
,hread);

142 
th»ad
->
t_¡ack
 = 
NULL
;

143 
th»ad
->
t_cÚ‹xt
 = 
NULL
;

144 
th»ad
->
t_ıu
 = 
NULL
;

145 
th»ad
->
t_´oc
 = 
NULL
;

148 
th»ad
->
t_š_š‹¼u±
 = 
çl£
;

149 
th»ad
->
t_cur¥l
 = 
IPL_HIGH
;

150 
th»ad
->
t_lhigh_couÁ
 = 1;

154  
th»ad
;

155 
	}
}

165 
ıu
 *

166 
	$ıu_ü—‹
(
h¬dw¬e_numb”
)

168 
ıu
 *
c
;

169 
»suÉ
;

170 
Çmebuf
[16];

172 
c
 = 
	`km®loc
((*c));

173 ià(
c
 =ğ
NULL
) {

174 
	`·nic
("cpu_create: Out of memory\n");

177 
c
->
c_£lf
 = c;

178 
c
->
c_h¬dw¬e_numb”
 = 
h¬dw¬e_numb”
;

180 
c
->
c_cu¹h»ad
 = 
NULL
;

181 
	`th»adli¡_š™
(&
c
->
c_zomb›s
);

182 
c
->
c_h¬dşocks
 = 0;

184 
c
->
c_isidË
 = 
çl£
;

185 
	`th»adli¡_š™
(&
c
->
c_runqueue
);

186 
	`¥šlock_š™
(&
c
->
c_runqueue_lock
);

188 
c
->
c_i_³ndšg
 = 0;

189 
c
->
c_numshoÙdown
 = 0;

190 
	`¥šlock_š™
(&
c
->
c_i_lock
);

192 
»suÉ
 = 
	`ıu¬¿y_add
(&
®lıus
, 
c
, &c->
c_numb”
);

193 ià(
»suÉ
 != 0) {

194 
	`·nic
("ıu_ü—‹:‡¼ay_add: %s\n", 
	`¡»¼Ü
(
»suÉ
));

197 
	`¢´štf
(
Çmebuf
, Òamebuf), "<boÙ #%d>", 
c
->
c_numb”
);

198 
c
->
c_cu¹h»ad
 = 
	`th»ad_ü—‹
(
Çmebuf
);

199 ià(
c
->
c_cu¹h»ad
 =ğ
NULL
) {

200 
	`·nic
("cpu_create:hread_create failed\n");

202 
»suÉ
 = 
	`´oc_addth»ad
(
k´oc
, 
c
->
c_cu¹h»ad
);

203 ià(
»suÉ
) {

204 
	`·nic
("ıu_ü—‹:…roc_addth»ad:: %s\n", 
	`¡»¼Ü
(
»suÉ
));

207 ià(
c
->
c_numb”
 == 0) {

217 
c
->
c_cu¹h»ad
->
t_¡ack
 = 
	`km®loc
(
STACK_SIZE
);

218 ià(
c
->
c_cu¹h»ad
->
t_¡ack
 =ğ
NULL
) {

219 
	`·nic
("cpu_create: couldn't‡llocate stack");

221 
	`th»ad_check¡ack_š™
(
c
->
c_cu¹h»ad
);

223 
c
->
c_cu¹h»ad
->
t_ıu
 = c;

225 
	`ıu_machd•_š™
(
c
);

227  
c
;

228 
	}
}

240 
	$th»ad_de¡roy
(
th»ad
 *thread)

242 
	`KASSERT
(
th»ad
 !ğ
cu¹h»ad
);

243 
	`KASSERT
(
th»ad
->
t_¡©e
 !ğ
S_RUN
);

251 
	`KASSERT
(
th»ad
->
t_´oc
 =ğ
NULL
);

252 ià(
th»ad
->
t_¡ack
 !ğ
NULL
) {

253 
	`kä“
(
th»ad
->
t_¡ack
);

255 
	`th»adli¡node_ş—nup
(&
th»ad
->
t_li¡node
);

256 
	`th»ad_machd•_ş—nup
(&
th»ad
->
t_machd•
);

259 
th»ad
->
t_wchª_Çme
 = "DESTROYED";

261 
	`kä“
(
th»ad
->
t_Çme
);

262 
	`kä“
(
th»ad
);

263 
	}
}

273 
	$exÜci£
()

275 
th»ad
 *
z
;

277 (
z
 = 
	`th»adli¡_»mh—d
(&
curıu
->
c_zomb›s
)è!ğ
NULL
) {

278 
	`KASSERT
(
z
 !ğ
cu¹h»ad
);

279 
	`KASSERT
(
z
->
t_¡©e
 =ğ
S_ZOMBIE
);

280 
	`th»ad_de¡roy
(
z
);

282 
	}
}

290 
	$th»ad_·nic
()

297 
	`i_brßdÿ¡
(
IPI_PANIC
);

306 
curıu
->
c_runqueue
.
_couÁ
 = 0;

307 
curıu
->
c_runqueue
.
_h—d
.
n_Ãxt
 = 
NULL
;

308 
curıu
->
c_runqueue
.
_
.
n_´ev
 = 
NULL
;

326 
	}
}

332 
	$th»ad_shutdown
()

340 
	`i_brßdÿ¡
(
IPI_OFFLINE
);

341 
	}
}

347 
	$th»ad_boÙ¡¿p
()

349 
ıu
 *
boÙıu
;

350 
th»ad
 *
boÙth»ad
;

352 
	`ıu¬¿y_š™
(&
®lıus
);

362 
boÙıu
 = 
	`ıu_ü—‹
(0);

363 
boÙth»ad
 = 
boÙıu
->
c_cu¹h»ad
;

370 
	`INIT_CURCPU
(
boÙıu
, 
boÙth»ad
);

377 
cu¹h»ad
->
t_ıu
 = 
curıu
;

378 
curıu
->
c_cu¹h»ad
 = 
cu¹h»ad
;

381 
	`KASSERT
(
cu¹h»ad
->
t_´oc
 !ğ
NULL
);

384 
	}
}

395 
	$ıu_h©ch
(
soáw¬e_numb”
)

397 
	`KASSERT
(
curıu
 !ğ
NULL
);

398 
	`KASSERT
(
cu¹h»ad
 !ğ
NULL
);

399 
	`KASSERT
(
curıu
->
c_numb”
 =ğ
soáw¬e_numb”
);

401 
	`¥l0
();

403 
	`k´štf
("ıu%u: %s\n", 
soáw¬e_numb”
, 
	`ıu_id’tify
());

405 
	`V
(
ıu_¡¬tup_£m
);

406 
	`th»ad_ex™
();

407 
	}
}

413 
	$th»ad_¡¬t_ıus
()

415 
i
;

417 
	`k´štf
("ıu0: %s\n", 
	`ıu_id’tify
());

419 
ıu_¡¬tup_£m
 = 
	`£m_ü—‹
("cpu_hatch", 0);

420 
	`mašbus_¡¬t_ıus
();

422 
i
=0; i<
	`ıu¬¿y_num
(&
®lıus
) - 1; i++) {

423 
	`P
(
ıu_¡¬tup_£m
);

425 
	`£m_de¡roy
(
ıu_¡¬tup_£m
);

426 
ıu_¡¬tup_£m
 = 
NULL
;

427 
	}
}

436 
	$th»ad_make_ruÂabË
(
th»ad
 *
rg‘
, 
boŞ
 
®»ady_have_lock
)

438 
ıu
 *
rg‘ıu
;

439 
boŞ
 
isidË
;

442 
rg‘ıu
 = 
rg‘
->
t_ıu
;

444 ià(
®»ady_have_lock
) {

446 
	`KASSERT
(
	`¥šlock_do_i_hŞd
(&
rg‘ıu
->
c_runqueue_lock
));

449 
	`¥šlock_acquœe
(&
rg‘ıu
->
c_runqueue_lock
);

452 
isidË
 = 
rg‘ıu
->
c_isidË
;

453 
	`th»adli¡_add
(&
rg‘ıu
->
c_runqueue
, 
rg‘
);

454 ià(
isidË
) {

459 
	`i_£nd
(
rg‘ıu
, 
IPI_UNIDLE
);

462 ià(!
®»ady_have_lock
) {

463 
	`¥šlock_»Ëa£
(&
rg‘ıu
->
c_runqueue_lock
);

465 
	}
}

478 
th»ad_fÜk
(cÚ¡ *
Çme
,

479 
´oc
 *proc,

480 (*
’Œypošt
)(*
d©a1
, 
d©a2
),

481 *
d©a1
, 
d©a2
)

483 
th»ad
 *
Ãwth»ad
;

484 
»suÉ
;

486 #ifdeà
UW


487 
	`DEBUG
(
DB_THREADS
,"FÜkšgh»ad: %s\n",
Çme
);

490 
Ãwth»ad
 = 
	`th»ad_ü—‹
(
Çme
);

491 ià(
Ãwth»ad
 =ğ
NULL
) {

492  
ENOMEM
;

496 
Ãwth»ad
->
t_¡ack
 = 
	`km®loc
(
STACK_SIZE
);

497 ià(
Ãwth»ad
->
t_¡ack
 =ğ
NULL
) {

498 
	`th»ad_de¡roy
(
Ãwth»ad
);

499  
ENOMEM
;

501 
	`th»ad_check¡ack_š™
(
Ãwth»ad
);

508 
Ãwth»ad
->
t_ıu
 = 
cu¹h»ad
->t_cpu;

511 ià(
´oc
 =ğ
NULL
) {

512 
´oc
 = 
cu¹h»ad
->
t_´oc
;

514 
»suÉ
 = 
	`´oc_addth»ad
(
´oc
, 
Ãwth»ad
);

515 ià(
»suÉ
) {

517 
	`th»ad_de¡roy
(
Ãwth»ad
);

518  
»suÉ
;

526 
Ãwth»ad
->
t_lhigh_couÁ
++;

529 
	`sw™chäame_š™
(
Ãwth»ad
, 
’Œypošt
, 
d©a1
, 
d©a2
);

532 
	`th»ad_make_ruÂabË
(
Ãwth»ad
, 
çl£
);

535 
	}
}

548 
	$th»ad_sw™ch
(
th»ad¡©e_t
 
Ãw¡©e
, 
wchª
 *
wc
)

550 
th»ad
 *
cur
, *
Ãxt
;

551 
¥l
;

553 
	`DEBUGASSERT
(
curıu
->
c_cu¹h»ad
 =ğ
cu¹h»ad
);

554 
	`DEBUGASSERT
(
cu¹h»ad
->
t_ıu
 =ğ
curıu
->
c_£lf
);

557 
¥l
 = 
	`¥lhigh
();

559 
cur
 = 
cu¹h»ad
;

565 ià(
curıu
->
c_isidË
) {

566 
	`¥lx
(
¥l
);

571 
	`th»ad_check¡ack
(
cur
);

574 
	`¥šlock_acquœe
(&
curıu
->
c_runqueue_lock
);

577 ià(
Ãw¡©e
 =ğ
S_READY
 && 
	`th»adli¡_i£m±y
(&
curıu
->
c_runqueue
)) {

578 
	`¥šlock_»Ëa£
(&
curıu
->
c_runqueue_lock
);

579 
	`¥lx
(
¥l
);

584 
Ãw¡©e
) {

585 
S_RUN
:

586 
	`·nic
("Illegal S_RUN inhread_switch\n");

587 
S_READY
:

588 
	`th»ad_make_ruÂabË
(
cur
, 
Œue
 );

590 
S_SLEEP
:

591 
cur
->
t_wchª_Çme
 = 
wc
->
wc_Çme
;

605 
	`th»adli¡_add
(&
wc
->
wc_th»ads
, 
cur
);

606 
	`wchª_uÆock
(
wc
);

608 
S_ZOMBIE
:

609 
cur
->
t_wchª_Çme
 = "ZOMBIE";

610 
	`th»adli¡_add
(&
curıu
->
c_zomb›s
, 
cur
);

613 
cur
->
t_¡©e
 = 
Ãw¡©e
;

633 
curıu
->
c_isidË
 = 
Œue
;

635 
Ãxt
 = 
	`th»adli¡_»mh—d
(&
curıu
->
c_runqueue
);

636 ià(
Ãxt
 =ğ
NULL
) {

637 
	`¥šlock_»Ëa£
(&
curıu
->
c_runqueue_lock
);

638 
	`ıu_idË
();

639 
	`¥šlock_acquœe
(&
curıu
->
c_runqueue_lock
);

641 } 
Ãxt
 =ğ
NULL
);

642 
curıu
->
c_isidË
 = 
çl£
;

651 
curıu
->
c_cu¹h»ad
 = 
Ãxt
;

652 
cu¹h»ad
 = 
Ãxt
;

655 
	`sw™chäame_sw™ch
(&
cur
->
t_cÚ‹xt
, &
Ãxt
->t_context);

705 
cur
->
t_wchª_Çme
 = 
NULL
;

706 
cur
->
t_¡©e
 = 
S_RUN
;

709 
	`¥šlock_»Ëa£
(&
curıu
->
c_runqueue_lock
);

712 
	`as_aùiv©e
();

715 
	`exÜci£
();

718 
	`¥lx
(
¥l
);

719 
	}
}

730 
th»ad_¡¬tup
((*
’Œypošt
)(*
d©a1
, 
d©a2
),

731 *
d©a1
, 
d©a2
)

733 
th»ad
 *
cur
;

735 
cur
 = 
cu¹h»ad
;

738 
cur
->
t_wchª_Çme
 = 
NULL
;

739 
cur
->
t_¡©e
 = 
S_RUN
;

742 
	`¥šlock_»Ëa£
(&
curıu
->
c_runqueue_lock
);

745 
	`as_aùiv©e
();

748 
	`exÜci£
();

751 
	`¥l0
();

753 #ià
OPT_SYNCHPROBS


756 
i
, 
n
;

757 
n
 = 
	`¿ndom
()%161 +„andom()%161;

758 
i
=0; i<
n
; i++) {

759 
	`th»ad_y›ld
();

765 
	`’Œypošt
(
d©a1
, 
d©a2
);

768 
	`th»ad_ex™
();

769 
	}
}

781 
	$th»ad_ex™
()

783 
th»ad
 *
cur
;

785 
cur
 = 
cu¹h»ad
;

787 #ifdeà
UW


790 
	`KASSERT
(
cu½roc
 =ğ
k´oc
 || cu½roø=ğ
NULL
);

792 ià(
cu½roc
 =ğ
k´oc
) {

793 
	`´oc_»mth»ad
(
cur
);

796 
	`´oc_»mth»ad
(
cur
);

800 
	`KASSERT
(
cur
->
t_´oc
 =ğ
NULL
);

803 
	`th»ad_check¡ack
(
cur
);

806 
	`¥lhigh
();

807 
	`th»ad_sw™ch
(
S_ZOMBIE
, 
NULL
);

808 
	`·nic
("The zombie walks!\n");

809 
	}
}

815 
	$th»ad_y›ld
()

817 
	`th»ad_sw™ch
(
S_READY
, 
NULL
);

818 
	}
}

830 
	$scheduË
()

836 
	}
}

856 
	$th»ad_cÚsid”_mig¿tiÚ
()

858 
my_couÁ
, 
tÙ®_couÁ
, 
Úe_sh¬e
, 
to_£nd
;

859 
i
, 
numıus
;

860 
ıu
 *
c
;

861 
th»adli¡
 
viùims
;

862 
th»ad
 *
t
;

864 
my_couÁ
 = 
tÙ®_couÁ
 = 0;

865 
numıus
 = 
	`ıu¬¿y_num
(&
®lıus
);

866 
i
=0; i<
numıus
; i++) {

867 
c
 = 
	`ıu¬¿y_g‘
(&
®lıus
, 
i
);

868 
	`¥šlock_acquœe
(&
c
->
c_runqueue_lock
);

869 
tÙ®_couÁ
 +ğ
c
->
c_runqueue
.
_couÁ
;

870 ià(
c
 =ğ
curıu
->
c_£lf
) {

871 
my_couÁ
 = 
c
->
c_runqueue
.
_couÁ
;

873 
	`¥šlock_»Ëa£
(&
c
->
c_runqueue_lock
);

876 
Úe_sh¬e
 = 
	`DIVROUNDUP
(
tÙ®_couÁ
, 
numıus
);

877 ià(
my_couÁ
 < 
Úe_sh¬e
) {

881 
to_£nd
 = 
my_couÁ
 - 
Úe_sh¬e
;

882 
	`th»adli¡_š™
(&
viùims
);

883 
	`¥šlock_acquœe
(&
curıu
->
c_runqueue_lock
);

884 
i
=0; i<
to_£nd
; i++) {

885 
t
 = 
	`th»adli¡_»m
(&
curıu
->
c_runqueue
);

886 
	`th»adli¡_addh—d
(&
viùims
, 
t
);

888 
	`¥šlock_»Ëa£
(&
curıu
->
c_runqueue_lock
);

890 
i
=0; i < 
numıus
 && 
to_£nd
 > 0; i++) {

891 
c
 = 
	`ıu¬¿y_g‘
(&
®lıus
, 
i
);

892 ià(
c
 =ğ
curıu
->
c_£lf
) {

895 
	`¥šlock_acquœe
(&
c
->
c_runqueue_lock
);

896 
c
->
c_runqueue
.
_couÁ
 < 
Úe_sh¬e
 && 
to_£nd
 > 0) {

897 
t
 = 
	`th»adli¡_»mh—d
(&
viùims
);

920 ià(
t
 =ğ
cu¹h»ad
) {

921 
	`th»adli¡_add
(&
viùims
, 
t
);

922 
to_£nd
--;

926 
t
->
t_ıu
 = 
c
;

927 
	`th»adli¡_add
(&
c
->
c_runqueue
, 
t
);

928 
	`DEBUG
(
DB_THREADS
,

930 
t
->
t_Çme
, 
curıu
->
c_numb”
, 
c
->c_number);

931 
to_£nd
--;

932 ià(
c
->
c_isidË
) {

937 
	`i_£nd
(
c
, 
IPI_UNIDLE
);

940 
	`¥šlock_»Ëa£
(&
c
->
c_runqueue_lock
);

948 ià(!
	`th»adli¡_i£m±y
(&
viùims
)) {

949 
	`¥šlock_acquœe
(&
curıu
->
c_runqueue_lock
);

950 (
t
 = 
	`th»adli¡_»mh—d
(&
viùims
)è!ğ
NULL
) {

951 
	`th»adli¡_add
(&
curıu
->
c_runqueue
, 
t
);

953 
	`¥šlock_»Ëa£
(&
curıu
->
c_runqueue_lock
);

956 
	`KASSERT
(
	`th»adli¡_i£m±y
(&
viùims
));

957 
	`th»adli¡_ş—nup
(&
viùims
);

958 
	}
}

974 
wchª
 *

975 
	$wchª_ü—‹
(cÚ¡ *
Çme
)

977 
wchª
 *
wc
;

979 
wc
 = 
	`km®loc
((*wc));

980 ià(
wc
 =ğ
NULL
) {

981  
NULL
;

983 
	`¥šlock_š™
(&
wc
->
wc_lock
);

984 
	`th»adli¡_š™
(&
wc
->
wc_th»ads
);

985 
wc
->
wc_Çme
 = 
Çme
;

986  
wc
;

987 
	}
}

994 
	$wchª_de¡roy
(
wchª
 *
wc
)

996 
	`¥šlock_ş—nup
(&
wc
->
wc_lock
);

997 
	`th»adli¡_ş—nup
(&
wc
->
wc_th»ads
);

998 
	`kä“
(
wc
);

999 
	}
}

1005 
	$wchª_lock
(
wchª
 *
wc
)

1007 
	`¥šlock_acquœe
(&
wc
->
wc_lock
);

1008 
	}
}

1011 
	$wchª_uÆock
(
wchª
 *
wc
)

1013 
	`¥šlock_»Ëa£
(&
wc
->
wc_lock
);

1014 
	}
}

1023 
	$wchª_¦“p
(
wchª
 *
wc
)

1026 
	`KASSERT
(!
cu¹h»ad
->
t_š_š‹¼u±
);

1028 
	`th»ad_sw™ch
(
S_SLEEP
, 
wc
);

1029 
	}
}

1035 
	$wchª_wakeÚe
(
wchª
 *
wc
)

1037 
th»ad
 *
rg‘
;

1040 
	`¥šlock_acquœe
(&
wc
->
wc_lock
);

1041 
rg‘
 = 
	`th»adli¡_»mh—d
(&
wc
->
wc_th»ads
);

1046 
	`¥šlock_»Ëa£
(&
wc
->
wc_lock
);

1048 ià(
rg‘
 =ğ
NULL
) {

1053 
	`th»ad_make_ruÂabË
(
rg‘
, 
çl£
);

1054 
	}
}

1060 
	$wchª_wak—Î
(
wchª
 *
wc
)

1062 
th»ad
 *
rg‘
;

1063 
th»adli¡
 
li¡
;

1065 
	`th»adli¡_š™
(&
li¡
);

1071 
	`¥šlock_acquœe
(&
wc
->
wc_lock
);

1072 (
rg‘
 = 
	`th»adli¡_»mh—d
(&
wc
->
wc_th»ads
)è!ğ
NULL
) {

1073 
	`th»adli¡_add
(&
li¡
, 
rg‘
);

1079 
	`¥šlock_»Ëa£
(&
wc
->
wc_lock
);

1086 (
rg‘
 = 
	`th»adli¡_»mh—d
(&
li¡
)è!ğ
NULL
) {

1087 
	`th»ad_make_ruÂabË
(
rg‘
, 
çl£
);

1090 
	`th»adli¡_ş—nup
(&
li¡
);

1091 
	}
}

1097 
boŞ


1098 
	$wchª_i£m±y
(
wchª
 *
wc
)

1100 
boŞ
 
»t
;

1102 
	`¥šlock_acquœe
(&
wc
->
wc_lock
);

1103 
»t
 = 
	`th»adli¡_i£m±y
(&
wc
->
wc_th»ads
);

1104 
	`¥šlock_»Ëa£
(&
wc
->
wc_lock
);

1106  
»t
;

1107 
	}
}

1119 
	$i_£nd
(
ıu
 *
rg‘
, 
code
)

1121 
	`KASSERT
(
code
 >= 0 && code < 32);

1123 
	`¥šlock_acquœe
(&
rg‘
->
c_i_lock
);

1124 
rg‘
->
c_i_³ndšg
 |ğ(
ušt32_t
)1 << 
code
;

1125 
	`mašbus_£nd_i
(
rg‘
);

1126 
	`¥šlock_»Ëa£
(&
rg‘
->
c_i_lock
);

1127 
	}
}

1130 
	$i_brßdÿ¡
(
code
)

1132 
i
;

1133 
ıu
 *
c
;

1135 
i
=0; i < 
	`ıu¬¿y_num
(&
®lıus
); i++) {

1136 
c
 = 
	`ıu¬¿y_g‘
(&
®lıus
, 
i
);

1137 ià(
c
 !ğ
curıu
->
c_£lf
) {

1138 
	`i_£nd
(
c
, 
code
);

1141 
	}
}

1144 
	$i_bshoÙdown
(
ıu
 *
rg‘
, cÚ¡ 
bshoÙdown
 *
m­pšg
)

1146 
n
;

1148 
	`¥šlock_acquœe
(&
rg‘
->
c_i_lock
);

1150 
n
 = 
rg‘
->
c_numshoÙdown
;

1151 ià(
n
 =ğ
TLBSHOOTDOWN_MAX
) {

1152 
rg‘
->
c_numshoÙdown
 = 
TLBSHOOTDOWN_ALL
;

1155 
rg‘
->
c_shoÙdown
[
n
] = *
m­pšg
;

1156 
rg‘
->
c_numshoÙdown
 = 
n
+1;

1159 
rg‘
->
c_i_³ndšg
 |ğ(
ušt32_t
)1 << 
IPI_TLBSHOOTDOWN
;

1160 
	`mašbus_£nd_i
(
rg‘
);

1162 
	`¥šlock_»Ëa£
(&
rg‘
->
c_i_lock
);

1163 
	}
}

1166 
	$š‹½roûssÜ_š‹¼u±
()

1168 
ušt32_t
 
b™s
;

1169 
i
;

1171 
	`¥šlock_acquœe
(&
curıu
->
c_i_lock
);

1172 
b™s
 = 
curıu
->
c_i_³ndšg
;

1174 ià(
b™s
 & (1U << 
IPI_PANIC
)) {

1176 
	`ıu_h®t
();

1178 ià(
b™s
 & (1U << 
IPI_OFFLINE
)) {

1180 
	`¥šlock_acquœe
(&
curıu
->
c_runqueue_lock
);

1181 ià(!
curıu
->
c_isidË
) {

1182 
	`k´štf
("cpu%d: offline: warning:‚ot idle\n",

1183 
curıu
->
c_numb”
);

1185 
	`¥šlock_»Ëa£
(&
curıu
->
c_runqueue_lock
);

1186 
	`k´štf
("ıu%d: ofæše.\n", 
curıu
->
c_numb”
);

1187 
	`ıu_h®t
();

1189 ià(
b™s
 & (1U << 
IPI_UNIDLE
)) {

1195 ià(
b™s
 & (1U << 
IPI_TLBSHOOTDOWN
)) {

1196 ià(
curıu
->
c_numshoÙdown
 =ğ
TLBSHOOTDOWN_ALL
) {

1197 
	`vm_bshoÙdown_®l
();

1200 
i
=0; i<
curıu
->
c_numshoÙdown
; i++) {

1201 
	`vm_bshoÙdown
(&
curıu
->
c_shoÙdown
[
i
]);

1204 
curıu
->
c_numshoÙdown
 = 0;

1207 
curıu
->
c_i_³ndšg
 = 0;

1208 
	`¥šlock_»Ëa£
(&
curıu
->
c_i_lock
);

1209 
	}
}

	@threadlist.c

34 
	~<ty³s.h
>

35 
	~<lib.h
>

36 
	~<th»ad.h
>

37 
	~<th»adli¡.h
>

40 
	$th»adli¡node_š™
(
th»adli¡node
 *
n
, 
th»ad
 *
t
)

42 
	`DEBUGASSERT
(
n
 !ğ
NULL
);

43 
	`KASSERT
(
t
 !ğ
NULL
);

45 
n
->
n_Ãxt
 = 
NULL
;

46 
n
->
n_´ev
 = 
NULL
;

47 
n
->
n_£lf
 = 
t
;

48 
	}
}

51 
	$th»adli¡node_ş—nup
(
th»adli¡node
 *
n
)

53 
	`DEBUGASSERT
(
n
 !ğ
NULL
);

55 
	`KASSERT
(
n
->
n_Ãxt
 =ğ
NULL
);

56 
	`KASSERT
(
n
->
n_´ev
 =ğ
NULL
);

57 
	`KASSERT
(
n
->
n_£lf
 !ğ
NULL
);

58 
	}
}

61 
	$th»adli¡_š™
(
th»adli¡
 *

)

63 
	`DEBUGASSERT
(

 !ğ
NULL
);

65 

->
_h—d
.
n_Ãxt
 = &->
_
;

66 

->
_h—d
.
n_´ev
 = 
NULL
;

67 

->
_
.
n_Ãxt
 = 
NULL
;

68 

->
_
.
n_´ev
 = &->
_h—d
;

69 

->
_h—d
.
n_£lf
 = 
NULL
;

70 

->
_
.
n_£lf
 = 
NULL
;

71 

->
_couÁ
 = 0;

72 
	}
}

75 
	$th»adli¡_ş—nup
(
th»adli¡
 *

)

77 
	`DEBUGASSERT
(

 !ğ
NULL
);

78 
	`DEBUGASSERT
(

->
_h—d
.
n_Ãxt
 =ğ&->
_
);

79 
	`DEBUGASSERT
(

->
_h—d
.
n_´ev
 =ğ
NULL
);

80 
	`DEBUGASSERT
(

->
_
.
n_Ãxt
 =ğ
NULL
);

81 
	`DEBUGASSERT
(

->
_
.
n_´ev
 =ğ&->
_h—d
);

82 
	`DEBUGASSERT
(

->
_h—d
.
n_£lf
 =ğ
NULL
);

83 
	`DEBUGASSERT
(

->
_
.
n_£lf
 =ğ
NULL
);

85 
	`KASSERT
(
	`th»adli¡_i£m±y
(

));

86 
	`KASSERT
(

->
_couÁ
 == 0);

89 
	}
}

91 
boŞ


92 
	$th»adli¡_i£m±y
(
th»adli¡
 *

)

94 
	`DEBUGASSERT
(

 !ğ
NULL
);

96  (

->
_couÁ
 == 0);

97 
	}
}

107 
	$th»adli¡_š£¹aá”node
(
th»adli¡node
 *
Úli¡
, 
th»ad
 *
t
)

109 
th»adli¡node
 *
add“
;

111 
add“
 = &
t
->
t_li¡node
;

113 
	`DEBUGASSERT
(
add“
->
n_´ev
 =ğ
NULL
);

114 
	`DEBUGASSERT
(
add“
->
n_Ãxt
 =ğ
NULL
);

116 
add“
->
n_´ev
 = 
Úli¡
;

117 
add“
->
n_Ãxt
 = 
Úli¡
->tln_next;

118 
add“
->
n_´ev
->
n_Ãxt
 =‡ddee;

119 
add“
->
n_Ãxt
->
n_´ev
 =‡ddee;

120 
	}
}

127 
	$th»adli¡_š£¹befÜ’ode
(
th»ad
 *
t
, 
th»adli¡node
 *
Úli¡
)

129 
th»adli¡node
 *
add“
;

131 
add“
 = &
t
->
t_li¡node
;

133 
	`DEBUGASSERT
(
add“
->
n_´ev
 =ğ
NULL
);

134 
	`DEBUGASSERT
(
add“
->
n_Ãxt
 =ğ
NULL
);

136 
add“
->
n_´ev
 = 
Úli¡
->tln_prev;

137 
add“
->
n_Ãxt
 = 
Úli¡
;

138 
add“
->
n_´ev
->
n_Ãxt
 =‡ddee;

139 
add“
->
n_Ãxt
->
n_´ev
 =‡ddee;

140 
	}
}

147 
	$th»adli¡_»mov’ode
(
th»adli¡node
 *
n
)

149 
	`DEBUGASSERT
(
n
 !ğ
NULL
);

150 
	`DEBUGASSERT
(
n
->
n_´ev
 !ğ
NULL
);

151 
	`DEBUGASSERT
(
n
->
n_Ãxt
 !ğ
NULL
);

153 
n
->
n_´ev
->
n_Ãxt
 =ln->tln_next;

154 
n
->
n_Ãxt
->
n_´ev
 =ln->tln_prev;

155 
n
->
n_´ev
 = 
NULL
;

156 
n
->
n_Ãxt
 = 
NULL
;

157 
	}
}

163 
	$th»adli¡_addh—d
(
th»adli¡
 *

, 
th»ad
 *
t
)

165 
	`DEBUGASSERT
(

 !ğ
NULL
);

166 
	`DEBUGASSERT
(
t
 !ğ
NULL
);

168 
	`th»adli¡_š£¹aá”node
(&

->
_h—d
, 
t
);

169 

->
_couÁ
++;

170 
	}
}

173 
	$th»adli¡_add
(
th»adli¡
 *

, 
th»ad
 *
t
)

175 
	`DEBUGASSERT
(

 !ğ
NULL
);

176 
	`DEBUGASSERT
(
t
 !ğ
NULL
);

178 
	`th»adli¡_š£¹befÜ’ode
(
t
, &

->
_
);

179 

->
_couÁ
++;

180 
	}
}

182 
th»ad
 *

183 
	$th»adli¡_»mh—d
(
th»adli¡
 *

)

185 
th»adli¡node
 *
n
;

187 
	`DEBUGASSERT
(

 !ğ
NULL
);

189 
n
 = 

->
_h—d
.
n_Ãxt
;

190 ià(
n
->
n_Ãxt
 =ğ
NULL
) {

192  
NULL
;

194 
	`th»adli¡_»mov’ode
(
n
);

195 
	`DEBUGASSERT
(

->
_couÁ
 > 0);

196 

->
_couÁ
--;

197  
n
->
n_£lf
;

198 
	}
}

200 
th»ad
 *

201 
	$th»adli¡_»m
(
th»adli¡
 *

)

203 
th»adli¡node
 *
n
;

205 
	`DEBUGASSERT
(

 !ğ
NULL
);

207 
n
 = 

->
_
.
n_´ev
;

208 ià(
n
->
n_´ev
 =ğ
NULL
) {

210  
NULL
;

212 
	`th»adli¡_»mov’ode
(
n
);

213 
	`DEBUGASSERT
(

->
_couÁ
 > 0);

214 

->
_couÁ
--;

215  
n
->
n_£lf
;

216 
	}
}

219 
	$th»adli¡_š£¹aá”
(
th»adli¡
 *

,

220 
th»ad
 *
Úli¡
, th»ad *
add“
)

222 
	`th»adli¡_š£¹aá”node
(&
Úli¡
->
t_li¡node
, 
add“
);

223 

->
_couÁ
++;

224 
	}
}

227 
	$th»adli¡_š£¹befÜe
(
th»adli¡
 *

,

228 
th»ad
 *
add“
, th»ad *
Úli¡
)

230 
	`th»adli¡_š£¹befÜ’ode
(
add“
, &
Úli¡
->
t_li¡node
);

231 

->
_couÁ
++;

232 
	}
}

235 
	$th»adli¡_»move
(
th»adli¡
 *

, 
th»ad
 *
t
)

237 
	`th»adli¡_»mov’ode
(&
t
->
t_li¡node
);

238 
	`DEBUGASSERT
(

->
_couÁ
 > 0);

239 

->
_couÁ
--;

240 
	}
}

	@
1
.
1
/usr/include
6
55
clock.c
spinlock.c
spl.c
synch.c
thread.c
threadlist.c
